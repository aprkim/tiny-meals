<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tiny Meals â€“ Weekly meal planning for couples</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <meta property="og:title" content="Tiny Meals">
    <meta property="og:description" content="Weekly meal planning, grocery lists, and recipe memory for couples.">
    <meta property="og:type" content="website">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #F7FAFC;
            min-height: 100vh;
        }

        input:focus,
        textarea:focus,
        button:focus {
            outline: none;
            border-color: #BF3143 !important;
        }

        /* ==================== ONBOARDING ==================== */
        .onboarding {
            min-height: 100vh;
            background: #F7FAFC;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 32px;
        }

        .onboarding-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .onboarding-logo {
            width: 64px;
            height: 64px;
            background: #BF3143;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        .onboarding-logo svg {
            width: 32px;
            height: 32px;
            fill: white;
        }

        .onboarding-title {
            font-size: 28px;
            font-weight: 650;
            color: #333;
            margin-bottom: 8px;
        }

        .onboarding-subtitle {
            font-size: 14px;
            font-weight: 400;
            color: #6A6F77;
            text-align: center;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
        }

        .setup-form {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-top: 20px;
        }

        .user-picker {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .user-btn {
            flex: 1;
            padding: 16px;
            background: white;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-btn:hover {
            border-color: #BF3143;
            background: #FEF7F8;
        }

        @media (min-width: 768px) {
            .onboarding {
                padding: 40px 20px;
            }

            .onboarding-header {
                margin-bottom: 40px;
            }

            .onboarding-logo {
                width: 80px;
                height: 80px;
                border-radius: 20px;
                margin: 0 auto 20px;
            }

            .onboarding-logo svg {
                width: 40px;
                height: 40px;
            }

            .onboarding-title {
                font-size: 32px;
            }

            .onboarding-subtitle {
                font-size: 15px;
            }

            .setup-form {
                padding: 32px;
            }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 6px;
        }

        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                font-size: 14px;
                margin-bottom: 8px;
            }
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #BF3143;
            background: #FEF7F8;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: #BF3143;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        @media (min-width: 768px) {
            .btn-primary {
                padding: 14px;
            }
        }

        .btn-primary:hover {
            background: #A02838;
        }

        .btn-primary:disabled {
            background: #e2e8f0;
            cursor: not-allowed;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 16px;
            font-size: 13px;
            color: #64748b;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #BF3143;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        /* ==================== MAIN APP ==================== */
        .app {
            display: none;
            padding-bottom: 80px;
        }

        .app.active {
            display: block;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==================== HEADER ==================== */
        .header {
            margin-bottom: 32px;
        }

        .header-title {
            font-size: 28px;
            font-weight: 650;
            color: #333;
            margin-bottom: 6px;
        }

        .header-subtitle {
            font-size: 13px;
            color: #94A3B8;
            font-weight: 400;
        }

        /* ==================== VIEW CONTAINERS ==================== */
        .view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==================== BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #E2E8F0;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .bottom-nav.hidden {
            display: none;
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #64748B;
            transition: color 0.2s;
            border-radius: 10px;
        }

        .nav-tab:hover {
            background: #F5F5F5;
        }

        .nav-tab.active {
            color: #BF3143;
        }

        .nav-tab svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .nav-tab span {
            font-size: 12px;
            font-weight: 600;
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .modal-close {
            position: absolute;
            top: 14px;
            right: 14px;
            background: none;
            border: none;
            color: #94A3B8;
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #F1F5F9;
            color: #64748B;
        }

        /* ==================== COMMON COMPONENTS ==================== */
        .card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1.5px solid #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #94a3b8;
        }

        .btn-secondary {
            padding: 10px 16px;
            background: white;
            color: #64748B;
            border: 2px solid #E2E8F0;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #BF3143;
            color: #BF3143;
            background: #FEF7F8;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94A3B8;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 8px;
        }

        .empty-state-subtitle {
            font-size: 13px;
            color: #94A3B8;
        }

        /* ==================== TAG SYSTEM ==================== */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: #F1F5F9;
            color: #64748B;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
        }

        .tag.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag.clickable:hover {
            background: #E2E8F0;
            color: #475569;
        }

        .tag.active {
            background: #BF3143;
            color: white;
        }

        /* ==================== IDEA TABS ==================== */
        .idea-tab {
            flex: 1;
            padding: 8px 16px;
            background: #F1F5F9;
            color: #64748B;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .idea-tab.active {
            background: #BF3143;
            color: white;
        }

        .idea-input-section {
            display: none;
        }

        .idea-input-section.active {
            display: block;
        }

        /* ==================== IDEAS & RECIPES LIST ==================== */
        .idea-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
        }

        .idea-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .idea-card-type {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94A3B8;
        }

        .idea-card-value {
            font-size: 15px;
            color: #333;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .idea-card-link {
            color: #BF3143;
            text-decoration: none;
        }

        .idea-card-link:hover {
            text-decoration: underline;
        }

        .idea-card-photo {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .idea-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-promote {
            background: #BF3143;
            color: white;
        }

        .btn-promote:hover {
            background: #A02838;
        }

        .btn-delete {
            background: #F1F5F9;
            color: #64748B;
        }

        .btn-delete:hover {
            background: #E2E8F0;
            color: #475569;
        }

        /* ==================== RECIPE FILTERS ==================== */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .filter-bar::-webkit-scrollbar {
            height: 4px;
        }

        .filter-bar::-webkit-scrollbar-thumb {
            background: #E2E8F0;
            border-radius: 4px;
        }

        /* ==================== ADD BUTTON ==================== */
        .floating-add-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #BF3143;
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(191, 49, 67, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 99;
        }

        .floating-add-btn:hover {
            background: #A02838;
            transform: scale(1.05);
        }

        .floating-add-btn svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        /* ==================== WEEKLY PLANNING ==================== */
        .week-date {
            font-size: 14px;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 20px;
            text-align: center;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (min-width: 768px) {
            .selection-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .selection-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .selection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .selection-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .selection-count {
            font-size: 13px;
            font-weight: 600;
            color: #BF3143;
        }

        .meal-slot {
            background: #F7FAFC;
            border: 2px dashed #E2E8F0;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .meal-slot:hover {
            border-color: #BF3143;
            background: #FEF7F8;
        }

        .meal-slot.filled {
            background: white;
            border: 2px solid #E2E8F0;
            justify-content: space-between;
            align-items: flex-start;
        }

        .meal-slot.filled:hover {
            border-color: #BF3143;
        }

        .meal-slot-empty {
            color: #94A3B8;
            font-size: 14px;
            text-align: center;
        }

        .meal-info {
            flex: 1;
        }

        .meal-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .meal-meta {
            font-size: 12px;
            color: #94A3B8;
        }

        .meal-remove {
            background: #F1F5F9;
            border: none;
            color: #64748B;
            font-size: 18px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .meal-remove:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .balance-warnings {
            background: #FEF7F8;
            border-left: 4px solid #BF3143;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .balance-warning-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .balance-warning-item {
            font-size: 14px;
            color: #64748B;
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .balance-warning-item:last-child {
            margin-bottom: 0;
        }

        .suggestions {
            margin-top: 12px;
        }

        .suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: #94A3B8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .suggestion-card {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #E2E8F0;
        }

        .suggestion-card:hover {
            border-color: #BF3143;
            background: #FEF7F8;
        }

        .suggestion-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .suggestion-tags {
            font-size: 12px;
            color: #94A3B8;
            margin-top: 2px;
        }

        .final-plan {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .final-plan-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .final-meal {
            background: #F7FAFC;
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .final-meal-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .final-meal-who {
            font-size: 12px;
            color: #94A3B8;
        }

        /* ==================== GROCERY LIST ==================== */
        .grocery-category {
            margin-bottom: 24px;
        }

        .grocery-category-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #E2E8F0;
        }

        .grocery-item {
            background: white;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .grocery-item:hover {
            background: #F7FAFC;
        }

        .grocery-item.checked {
            opacity: 0.5;
        }

        .grocery-item.checked .grocery-item-name {
            text-decoration: line-through;
            color: #94A3B8;
        }

        .grocery-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #E2E8F0;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .grocery-item.checked .grocery-checkbox {
            background: #BF3143;
            border-color: #BF3143;
        }

        .grocery-checkbox svg {
            width: 12px;
            height: 12px;
            stroke: white;
            stroke-width: 3;
            fill: none;
            display: none;
        }

        .grocery-item.checked .grocery-checkbox svg {
            display: block;
        }

        .grocery-item-info {
            flex: 1;
        }

        .grocery-item-name {
            font-size: 15px;
            font-weight: 500;
            color: #333;
        }

        .grocery-item-quantity {
            font-size: 13px;
            color: #94A3B8;
            margin-top: 2px;
        }

        .grocery-item-delete {
            background: none;
            border: none;
            color: #CBD5E1;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s;
        }

        .grocery-item-delete:hover {
            color: #dc2626;
        }

        .grocery-warning {
            background: #FEF7F8;
            border-left: 4px solid #BF3143;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #64748B;
        }

        .add-grocery-item {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .add-grocery-input {
            flex: 1;
        }

        /* ==================== HISTORY & MEAL LOGS ==================== */
        .week-log {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .week-log-header {
            font-size: 15px;
            font-weight: 600;
            color: #64748B;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #E2E8F0;
        }

        .meal-log {
            padding: 12px 0;
            border-bottom: 1px solid #F1F5F9;
        }

        .meal-log:last-child {
            border-bottom: none;
        }

        .meal-log-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .meal-log-meta {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .cooked-toggle {
            background: none;
            border: 2px solid #E2E8F0;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748B;
        }

        .cooked-toggle.active {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }

        .rating-buttons {
            display: flex;
            gap: 6px;
        }

        .rating-btn {
            padding: 6px 12px;
            background: #F1F5F9;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748B;
        }

        .rating-btn:hover {
            border-color: #BF3143;
        }

        .rating-btn.active.love {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }

        .rating-btn.active.ok {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .rating-btn.active.skip {
            background: #fee2e2;
            border-color: #dc2626;
            color: #991b1b;
        }

        .guest-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #F1F5F9;
        }

        .guest-toggle-btn {
            background: none;
            border: none;
            color: #BF3143;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }

        .guest-selector {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .guest-chip {
            padding: 4px 10px;
            background: #F1F5F9;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748B;
        }

        .guest-chip.active {
            background: #FEF7F8;
            border-color: #BF3143;
            color: #BF3143;
        }

        .meal-log-notes textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            margin-top: 8px;
        }

        .meal-log-notes textarea:focus {
            outline: none;
            border-color: #BF3143;
        }

        /* ==================== MOBILE OPTIMIZATIONS ==================== */

        /* Touch-friendly sizing on mobile */
        @media (max-width: 767px) {
            .btn-primary,
            .btn-secondary {
                min-height: 44px; /* iOS recommended touch target */
            }

            .btn-small {
                min-height: 36px;
                padding: 8px 14px;
            }

            .nav-tab {
                min-height: 56px; /* Comfortable bottom nav taps */
            }

            .meal-slot {
                min-height: 64px; /* Easy to tap meal slots */
            }

            .grocery-item {
                min-height: 48px;
                padding: 12px;
            }

            .rating-btn {
                min-height: 36px;
                min-width: 64px;
            }

            .guest-chip {
                min-height: 32px;
                padding: 6px 12px;
            }

            /* Larger tap targets for checkboxes */
            .grocery-checkbox {
                width: 22px;
                height: 22px;
            }

            /* Photo upload buttons more prominent */
            #ideaPhotoButton,
            #recipePhotoButton {
                min-height: 48px;
                font-size: 15px;
            }

            /* Better spacing on mobile */
            .container {
                padding: 16px;
            }

            .header {
                margin-bottom: 20px;
            }

            /* Modal optimizations */
            .modal-content {
                max-height: 85vh;
                margin: auto 16px;
            }

            /* Filter tags more comfortable */
            .tag.clickable {
                min-height: 32px;
                padding: 6px 12px;
            }

            /* Form inputs comfortable for typing */
            .form-input,
            textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
                min-height: 44px;
            }
        }

        /* Desktop enhancements */
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .selection-grid {
                gap: 24px;
            }

            .recipe-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .recipe-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Settings page mobile optimizations */
        @media (max-width: 767px) {
            #settingsView .sync-buttons {
                flex-direction: column !important;
                gap: 8px !important;
            }

            #settingsView .sync-buttons button {
                flex: none !important;
                width: 100%;
            }

            #settingsView .sync-input-container {
                flex-direction: column !important;
                gap: 8px !important;
            }

            #settingsView .sync-input-container input {
                width: 100%;
            }

            #settingsView .sync-input-container button {
                width: 100%;
                min-width: auto !important;
            }

            #syncCodeCard {
                flex-direction: column !important;
                align-items: stretch !important;
            }

            #syncCodeCard button {
                width: 100%;
            }

            #settingsView h3 {
                font-size: 16px !important;
            }

            #settingsView .settings-card {
                padding: 16px !important;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Better focus states for accessibility */
        button:focus-visible,
        input:focus-visible,
        textarea:focus-visible {
            outline: 2px solid #BF3143;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- ==================== ONBOARDING VIEW ==================== -->
    <div class="onboarding" id="onboardingView">
        <div class="onboarding-header">
            <div class="onboarding-logo">
                <svg viewBox="0 0 24 24" fill="white">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                </svg>
            </div>
            <h1 class="onboarding-title">Tiny Meals</h1>
            <p class="onboarding-subtitle">Weekly meal planning, grocery lists, and recipe memory for couples.</p>
        </div>

        <div class="setup-form">
            <div class="form-group">
                <label class="form-label">Name your meal planning space</label>
                <input type="text" id="spaceName" class="form-input" placeholder="e.g., Our Kitchen, The Smiths, etc.">
            </div>
            <button class="btn-primary" onclick="createSpace()">Create space</button>

            <div style="margin-top: 16px; text-align: center;">
                <p style="font-size: 13px; color: #64748b; margin-bottom: 10px;">Already have a sync code?</p>
                <button class="btn-secondary" onclick="showOnboardingSyncInput()" style="width: 100%;">Enter sync code</button>
            </div>
        </div>
    </div>

    <!-- ==================== SYNC CODE INPUT ==================== -->
    <div id="onboardingSyncInput" class="onboarding" style="display: none;">
        <div class="onboarding-header">
            <h1 class="onboarding-title">Enter Sync Code</h1>
            <p class="onboarding-subtitle">Access your existing data across devices</p>
        </div>
        <div class="setup-form">
            <div class="form-group">
                <label class="form-label">Sync code</label>
                <input type="text" id="onboardingSyncCodeInput" class="form-input" placeholder="Enter sync code">
            </div>
            <button class="btn-primary" onclick="linkOnboardingSyncCode()">Connect</button>
            <button class="btn-secondary" onclick="backToOnboarding()" style="width: 100%; margin-top: 12px;">Back</button>
        </div>
    </div>


    <!-- ==================== MAIN APP ==================== -->
    <div class="app" id="mainApp">
        <!-- Ideas Inbox View -->
        <div class="view" id="ideasView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">Ideas Inbox</h1>
                    <p class="header-subtitle">Quick capture for recipes you want to try</p>
                </div>

                <!-- Quick Add Form -->
                <div class="card" style="margin-bottom: 24px;">
                    <form id="addIdeaForm">
                        <!-- Note Input (always visible) -->
                        <div class="form-group">
                            <textarea class="form-input" id="ideaNoteInput" placeholder="Recipe idea or quick note..." rows="3" style="resize: vertical;" spellcheck="true" lang="en"></textarea>
                        </div>

                        <!-- Link Input (optional) -->
                        <div class="form-group">
                            <input type="url" class="form-input" id="ideaLinkInput" placeholder="Recipe URL (optional)">
                        </div>

                        <!-- Photo Input (optional) -->
                        <div class="form-group">
                            <input type="file" id="ideaPhotoInput" accept="image/*" style="display: none;">
                            <button type="button" class="btn-secondary" id="ideaPhotoButton" style="width: 100%;" onclick="document.getElementById('ideaPhotoInput').click()">
                                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 8px; pointer-events: none;">
                                    <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                    <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                Add Photo (optional)
                            </button>
                            <div id="ideaPhotoPreview" style="margin-top: 12px; display: none; position: relative;">
                                <img style="max-width: 500px; max-height: 500px; width: 100%; border-radius: 8px; display: block; object-fit: contain;">
                                <button type="button" onclick="removeIdeaPhoto()" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">&times;</button>
                            </div>
                        </div>

                        <!-- Tag Input -->
                        <div class="form-group">
                            <input type="text" class="form-input" id="ideaTagsInput" placeholder="Tags (optional, comma-separated)">
                        </div>

                        <button type="submit" class="btn-primary" style="width: 100%;">Add Idea</button>
                    </form>
                </div>

                <!-- Ideas List -->
                <div id="ideasList"></div>

                <div class="empty-state" id="ideasEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                    <p class="empty-state-title">No ideas yet</p>
                    <p class="empty-state-subtitle">Add a link, note, or photo to get started</p>
                </div>
            </div>
        </div>

        <!-- Recipe Library View -->
        <div class="view" id="recipesView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">Recipe Library</h1>
                    <p class="header-subtitle">All your saved recipes</p>
                </div>

                <!-- Tag Filters -->
                <div class="filter-bar" id="recipeFilters">
                    <span class="tag clickable active" data-filter="all">All</span>
                    <span class="tag clickable" data-filter="chicken">chicken</span>
                    <span class="tag clickable" data-filter="beef">beef</span>
                    <span class="tag clickable" data-filter="fish">fish</span>
                    <span class="tag clickable" data-filter="veggie">veggie</span>
                    <span class="tag clickable" data-filter="pasta">pasta</span>
                    <span class="tag clickable" data-filter="quick">quick</span>
                    <span class="tag clickable" data-filter="guest-friendly">guest-friendly</span>
                </div>

                <!-- Recipes List -->
                <div id="recipesList"></div>

                <div class="empty-state" id="recipesEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <p class="empty-state-title">No recipes yet</p>
                    <p class="empty-state-subtitle">Add your first recipe to get started</p>
                </div>
            </div>

            <!-- Floating Add Button -->
            <button class="floating-add-btn" id="addRecipeBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M12 4v16m8-8H4"/>
                </svg>
            </button>
        </div>

        <!-- Weekly Planning View -->
        <div class="view active" id="planningView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">This Week</h1>
                    <p class="header-subtitle">Plan your meals together</p>
                </div>

                <div class="week-date" id="weekDate">Week of Dec 25, 2025</div>

                <!-- Step 1: Independent Selection -->
                <div id="selectionStep">
                    <div class="selection-grid">
                        <!-- April's Selection -->
                        <div class="selection-section">
                            <div class="selection-header">
                                <span class="selection-title">April's Picks</span>
                                <span class="selection-count" id="aprilCount">0/5</span>
                            </div>
                            <div id="aprilSlots"></div>
                        </div>

                        <!-- Nathan's Selection -->
                        <div class="selection-section">
                            <div class="selection-header">
                                <span class="selection-title">Nathan's Picks</span>
                                <span class="selection-count" id="nathanCount">0/5</span>
                            </div>
                            <div id="nathanSlots"></div>
                        </div>
                    </div>

                    <button class="btn-primary" id="checkBalanceBtn" style="display: none;">Check Balance & Continue</button>
                </div>

                <!-- Step 2: Balance Check & Suggestions -->
                <div id="balanceStep" style="display: none;">
                    <div id="balanceWarningsContainer"></div>

                    <div class="final-plan">
                        <div class="final-plan-title">Combined Plan (6 meals)</div>
                        <div id="combinedMealsList"></div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button class="btn-secondary" id="backToSelectionBtn" style="flex: 1;">Back to Selection</button>
                        <button class="btn-primary" id="confirmWeekBtn" style="flex: 2;">Confirm Week & Generate Grocery List</button>
                    </div>
                </div>

                <!-- Confirmed State -->
                <div id="confirmedStep" style="display: none;">
                    <div style="background: #dcfce7; border-left: 4px solid #16a34a; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="font-size: 15px; font-weight: 600; color: #15803d; margin-bottom: 4px;">Week Confirmed!</div>
                        <div style="font-size: 14px; color: #16a34a;">Your grocery list has been generated. Check the Grocery tab.</div>
                    </div>

                    <div class="final-plan">
                        <div class="final-plan-title">This Week's Meals</div>
                        <div id="confirmedMealsList"></div>
                    </div>

                    <button class="btn-secondary" id="resetWeekBtn" style="width: 100%;">Start New Week</button>
                </div>
            </div>
        </div>

        <!-- Grocery List View -->
        <div class="view" id="groceryView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">Grocery List</h1>
                    <p class="header-subtitle">Generated from this week's meals</p>
                </div>

                <!-- Warning for photo-only recipes -->
                <div id="groceryWarning" style="display: none;"></div>

                <!-- Manual Add Item -->
                <div class="add-grocery-item" id="addGrocerySection" style="display: none;">
                    <input type="text" class="form-input add-grocery-input" id="manualItemInput" placeholder="Add item manually...">
                    <button class="btn-secondary" id="addManualItemBtn">Add</button>
                </div>

                <!-- Grocery List by Category -->
                <div id="groceryListContainer"></div>

                <div class="empty-state" id="groceryEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <p class="empty-state-title">No grocery list yet</p>
                    <p class="empty-state-subtitle">Confirm your weekly plan to generate a list</p>
                </div>

                <!-- Clear List Button -->
                <button class="btn-secondary" id="clearGroceryBtn" style="width: 100%; margin-top: 20px; display: none;">Clear Checked Items</button>
            </div>
        </div>

        <!-- History View -->
        <div class="view" id="historyView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">History</h1>
                    <p class="header-subtitle">Past meals and ratings</p>
                </div>

                <!-- Guest Management Section -->
                <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <h3 style="font-size: 15px; font-weight: 600; color: #333; margin: 0;">Guests</h3>
                        <button class="btn-small btn-primary" id="addGuestBtn">+ Add Guest</button>
                    </div>
                    <div id="guestsList" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <!-- Guest chips will be rendered here -->
                    </div>
                    <div id="guestsEmptyState" style="display: none; font-size: 13px; color: #94A3B8; text-align: center; padding: 12px 0;">
                        No guests added yet
                    </div>
                </div>

                <div id="historyContainer"></div>

                <div class="empty-state" id="historyEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">
                            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <p class="empty-state-title">No history yet</p>
                    <p class="empty-state-subtitle">Complete a week to see your meal history</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div class="view" id="settingsView">
            <div class="container">
                <div class="header">
                    <h1 class="header-title">Settings</h1>
                    <p class="header-subtitle">Manage your meal planning space</p>
                </div>

                <!-- Cross-Device Sync Card -->
                <div class="settings-card" style="margin-top: 16px; padding: 20px; background: white; border-radius: 16px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                    <div style="display: flex; align-items: center; gap: 10px; margin: 0 0 8px 0;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #BF3143;">
                            <path d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #333;">Cross-Device Sync</h3>
                    </div>
                    <p style="margin: 0 0 16px 0; font-size: 14px; color: #64748b; line-height: 1.5;">Use a sync code to access your data across devices and browsers.</p>

                    <div class="sync-buttons" style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button class="btn-secondary" onclick="showSyncCodeCard()" style="flex: 1;">Show My Sync Code</button>
                        <button class="btn-secondary" onclick="shareSyncCode()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; margin-right: 4px; vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            Share
                        </button>
                    </div>

                    <div id="syncCodeCard" style="padding: 12px 14px; border: 2px solid #cbd5e1; border-radius: 12px; background: #f9fafb; margin-bottom: 12px; display: none; align-items: center; gap: 15px; min-height: 56px;">
                        <div style="flex: 1; min-width: 0;">
                            <div id="syncCodeDisplay" style="font-family: monospace; color: #111827; word-break: break-all; font-size: 15px; line-height: 1.4;"></div>
                        </div>
                        <button onclick="copySyncCode()" style="padding: 12px 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; background: #BF3143; color: #fff; cursor: pointer; transition: background 0.2s; min-width: 80px; display: flex; align-items: center; justify-content: center;">Copy</button>
                    </div>

                    <div class="sync-input-container" style="padding: 12px 14px; border: 2px solid #cbd5e1; border-radius: 12px; background: #f9fafb; display: flex; align-items: center; gap: 15px; min-height: 56px; margin-top: 12px;">
                        <input id="enterSyncCodeInput" type="text" placeholder="Enter sync code from another device" style="flex: 1; padding: 12px 14px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 14px; min-width: 0; background: white; outline: none; box-shadow: none;">
                        <button onclick="submitSyncCode()" style="padding: 12px 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; background: #eef2f7; color: #5b6474; cursor: pointer; transition: background 0.2s; min-width: 80px; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1;">Link</button>
                    </div>
                </div>

                <!-- Data Management Card -->
                <div class="settings-card" style="margin-top: 16px; padding: 20px; background: white; border-radius: 16px; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px rgba(0,0,0,0.04);">
                    <div style="display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: 600; color: #333; margin-bottom: 16px;">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; color: #BF3143;">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Data Management
                    </div>

                    <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 8px;">Export / Import</div>
                        <p style="margin: 0 0 12px 0; font-size: 13px; color: #64748b; line-height: 1.4;">Backup or restore your data.</p>
                        <button class="btn-secondary" onclick="exportData()" style="width: 100%; margin-bottom: 8px; background: #ffffff; color: #475569; border: 1px solid #e2e8f0;">Export Data</button>
                        <button class="btn-secondary" onclick="importData()" style="width: 100%; background: #ffffff; color: #475569; border: 1px solid #e2e8f0;">Import Data</button>
                    </div>

                    <div style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <div style="font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 8px;">Disconnect from Sync</div>
                        <p style="margin: 0 0 12px 0; font-size: 13px; color: #64748b; line-height: 1.4;">Stop syncing with other devices.</p>
                        <button class="btn-secondary" onclick="disconnectSync()" style="width: 100%; background: #ffffff; color: #475569; border: 1px solid #e2e8f0;">Disconnect Sync</button>
                    </div>

                    <div style="padding: 16px; background: #FFF6F6; border-radius: 12px; border: 1px solid #F2D6D6;">
                        <div style="font-size: 14px; font-weight: 600; color: #BF3143; margin-bottom: 8px;">Reset Everything</div>
                        <p style="margin: 0 0 12px 0; font-size: 13px; color: #64748b; line-height: 1.4;">Permanently delete all data from this device.</p>
                        <button class="btn-secondary btn-danger" onclick="resetApp()" style="width: 100%;">Reset Everything</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-tab active" data-view="planningView">
                <svg viewBox="0 0 24 24">
                    <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>Plan</span>
            </button>
            <button class="nav-tab" data-view="groceryView">
                <svg viewBox="0 0 24 24">
                    <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <span>Grocery</span>
            </button>
            <button class="nav-tab" data-view="recipesView">
                <svg viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <span>Recipes</span>
            </button>
            <button class="nav-tab" data-view="ideasView">
                <svg viewBox="0 0 24 24">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <span>Ideas</span>
            </button>
            <button class="nav-tab" data-view="settingsView">
                <svg viewBox="0 0 24 24">
                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>Settings</span>
            </button>
        </nav>
    </div>

    <!-- ==================== ADD RECIPE MODAL ==================== -->
    <div class="modal-overlay" id="addRecipeModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Recipe</h2>
                <button class="modal-close" id="closeRecipeModal">&times;</button>
            </div>

            <div class="add-idea-tabs" style="margin-bottom: 16px;">
                <button class="idea-tab active" data-type="manual">Manual</button>
                <button class="idea-tab" data-type="link">Link</button>
                <button class="idea-tab" data-type="photo">Photo</button>
            </div>

            <form id="addRecipeForm">
                <!-- Manual Input -->
                <div class="idea-input-section active" data-section="manual">
                    <div class="form-group">
                        <label class="form-label">Recipe Name</label>
                        <input type="text" class="form-input" id="recipeNameManual" placeholder="e.g. Chicken Tikka Masala">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipe Photo (optional)</label>
                        <input type="file" id="recipePhotoManual" accept="image/*" style="display: none;">
                        <button type="button" class="btn-secondary" style="width: 100%;" onclick="document.getElementById('recipePhotoManual').click()">
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 8px; pointer-events: none;">
                                <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Choose Photo
                        </button>
                        <div id="recipePhotoPreviewManual" style="margin-top: 12px; display: none;">
                            <img style="max-width: 100%; border-radius: 8px; max-height: 250px;">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipe Link (optional)</label>
                        <input type="url" class="form-input" id="recipeUrlManual" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ingredients</label>
                        <textarea class="form-input" id="recipeIngredients" placeholder="1 lb chicken&#10;2 cups rice&#10;1 can coconut milk" rows="6" style="resize: vertical; font-family: monospace; font-size: 14px;"></textarea>
                        <small style="color: #94A3B8; font-size: 12px; margin-top: 4px; display: block;">One ingredient per line. Format: quantity unit name</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-input" id="recipeNotes" placeholder="Any cooking tips or modifications..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Link Input -->
                <div class="idea-input-section" data-section="link">
                    <div class="form-group">
                        <label class="form-label">Recipe Name</label>
                        <input type="text" class="form-input" id="recipeNameLink" placeholder="e.g. Best Pasta Recipe">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipe URL</label>
                        <input type="url" class="form-input" id="recipeUrl" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ingredients</label>
                        <textarea class="form-input" id="recipeIngredientsLink" placeholder="1 lb chicken&#10;2 cups rice&#10;1 can coconut milk" rows="6" style="resize: vertical; font-family: monospace; font-size: 14px;"></textarea>
                        <small style="color: #94A3B8; font-size: 12px; margin-top: 4px; display: block;">One ingredient per line. Format: quantity unit name</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-input" id="recipeNotesLink" placeholder="Any cooking tips or modifications..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Photo Input -->
                <div class="idea-input-section" data-section="photo">
                    <div class="form-group">
                        <label class="form-label">Recipe Name</label>
                        <input type="text" class="form-input" id="recipeNamePhoto" placeholder="e.g. Mom's Lasagna">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipe Photo</label>
                        <input type="file" id="recipePhotoInput" accept="image/*" style="display: none;">
                        <button type="button" class="btn-secondary" id="recipePhotoButton" style="width: 100%;" onclick="document.getElementById('recipePhotoInput').click()">
                            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 8px; pointer-events: none;">
                                <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Choose Photo
                        </button>
                        <div id="recipePhotoPreview" style="margin-top: 12px; display: none;">
                            <img style="max-width: 100%; border-radius: 8px; max-height: 250px;">
                        </div>
                        <small style="color: #94A3B8; font-size: 12px; margin-top: 8px; display: block;">Photo-only recipes won't include ingredients in grocery lists</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-input" id="recipeNotesPhoto" placeholder="Any notes about this recipe..." rows="3" style="resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- Common Fields -->
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" class="form-input" id="recipeTags" placeholder="chicken, quick, guest-friendly">
                    <small style="color: #94A3B8; font-size: 12px; margin-top: 4px; display: block;">Comma-separated tags</small>
                </div>

                <button type="submit" class="btn-primary">Add Recipe</button>
            </form>
        </div>
    </div>

    <!-- ==================== CONFIRM MODAL ==================== -->
    <div id="confirmModal" class="modal-overlay" onclick="if(event.target === this) closeConfirmModal()">
        <div class="modal" style="max-width: 400px;">
            <h3 class="modal-title" id="confirmTitle" style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 12px;">Confirm</h3>
            <p class="modal-subtitle" id="confirmSubtitle" style="font-size: 13px; color: #64748B; margin-bottom: 24px;">Are you sure?</p>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="modal-btn-secondary" onclick="closeConfirmModal()" style="padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #f0f4f3; color: #64748b; transition: all 0.2s;">Cancel</button>
                <button class="modal-btn-primary" id="confirmBtn" style="padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; background: #BF3143; color: white; transition: all 0.2s;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- ==================== RECIPE DETAIL MODAL ==================== -->
    <div id="recipeDetailModal" class="modal-overlay" onclick="if(event.target === this) closeRecipeDetail()">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeRecipeDetail()">&times;</button>
            <div id="recipeDetailContent"></div>
        </div>
    </div>

    <!-- ==================== EDIT RECIPE MODAL ==================== -->
    <div id="editRecipeModal" class="modal-overlay" onclick="if(event.target === this) closeEditRecipe()">
        <div class="modal" style="max-width: 600px;">
            <button class="modal-close" onclick="closeEditRecipe()">&times;</button>
            <h2 class="modal-title" style="margin-bottom: 20px;">Edit Recipe</h2>
            <input type="hidden" id="editRecipeId">

            <div class="form-group">
                <label class="form-label">Recipe Name</label>
                <input type="text" class="form-input" id="editRecipeName" placeholder="e.g. Chicken Tikka Masala">
            </div>

            <div class="form-group">
                <label class="form-label">Recipe Photo (optional)</label>
                <input type="file" id="editRecipePhotoInput" accept="image/*" style="display: none;">
                <div id="editRecipePhotoPreview" style="margin-bottom: 12px; display: none;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <img style="max-width: 200px; border-radius: 8px; max-height: 200px; object-fit: cover;">
                        <button type="button" onclick="removeEditRecipePhoto()" style="background: #ef4444; border: none; border-radius: 8px; width: 36px; height: 36px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                                <line x1="18" y1="6" x2="6" y2="18" stroke-linecap="round"/>
                                <line x1="6" y1="6" x2="18" y2="18" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="btn-secondary" style="flex: 1;" onclick="document.getElementById('editRecipePhotoInput').click()">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 8px; pointer-events: none;">
                            <path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span id="editRecipePhotoButtonText">Choose Photo</span>
                    </button>
                    <button type="button" class="btn-secondary" style="flex: 1;" onclick="findImageOnline()">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 2; display: inline-block; vertical-align: middle; margin-right: 8px; pointer-events: none;">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        Find Image Online
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ingredients</label>
                <textarea class="form-input" id="editRecipeIngredients" placeholder="1 lb chicken&#10;2 cups rice&#10;1 can coconut milk" rows="6" style="resize: vertical;"></textarea>
                <small style="color: #94A3B8; font-size: 12px; margin-top: 4px; display: block;">One ingredient per line. Format: quantity unit name</small>
            </div>

            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="form-input" id="editRecipeNotes" placeholder="Any cooking tips or modifications..." rows="3" style="resize: vertical;"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Tags</label>
                <input type="text" class="form-input" id="editRecipeTags" placeholder="chicken, quick, guest-friendly">
                <small style="color: #94A3B8; font-size: 12px; margin-top: 4px; display: block;">Comma-separated tags</small>
            </div>

            <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeEditRecipe()">Cancel</button>
                <button class="btn-primary" onclick="saveRecipeEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- ==================== SELECT RECIPE MODAL ==================== -->
    <div class="modal-overlay" id="selectRecipeModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Select a Recipe</h2>
                <button class="modal-close" id="closeSelectModal">&times;</button>
            </div>

            <div class="filter-bar" id="selectRecipeFilters" style="margin-bottom: 16px;">
                <span class="tag clickable active" data-filter="all">All</span>
                <span class="tag clickable" data-filter="chicken">chicken</span>
                <span class="tag clickable" data-filter="beef">beef</span>
                <span class="tag clickable" data-filter="fish">fish</span>
                <span class="tag clickable" data-filter="veggie">veggie</span>
                <span class="tag clickable" data-filter="pasta">pasta</span>
                <span class="tag clickable" data-filter="quick">quick</span>
            </div>

            <div id="selectRecipesList" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Tesseract.js for OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script>
      // ==================== FIREBASE CONFIGURATION ====================
      const firebaseConfig = {
        apiKey: "AIzaSyCPFo59tGIYY5aToyTUmvw-qpyNRzbdTa4",
        authDomain: "tiny-meals.firebaseapp.com",
        projectId: "tiny-meals",
        storageBucket: "tiny-meals.firebasestorage.app",
        messagingSenderId: "1015310720996",
        appId: "1:1015310720996:web:c09057b7d1732ab5b871f1"
      };

      // Initialize Firebase
      let db, auth, storage;

      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
        storage = firebase.storage();

        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
          .catch((err) => {
            if (err.code === 'failed-precondition') {
              console.warn('âš ï¸ Persistence: Multiple tabs open');
            } else if (err.code === 'unimplemented') {
              console.warn('âš ï¸ Persistence not available');
            }
          });
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }

      // ==================== GLOBAL STATE ====================
      let currentUser = null;
      let isSignUpMode = false;
      let appState = {
        space: null,
        syncCode: null
      };

      const STORAGE_KEYS = {
        SPACE: 'tinyMeals_space',
        SYNC_CODE: 'tinyMeals_syncCode'
      };

      // ==================== ONBOARDING FUNCTIONS ====================
      window.createSpace = function() {
        const spaceName = document.getElementById('spaceName').value.trim();

        if (!spaceName) {
          alert('Please enter a name for your space');
          return;
        }

        appState.space = {
          id: 'space_' + Date.now(),
          name: spaceName,
          created_at: Date.now()
        };

        localStorage.setItem(STORAGE_KEYS.SPACE, JSON.stringify(appState.space));
        console.log('âœ… Space created:', spaceName);

        showApp();
      };

      window.showOnboardingSyncInput = function() {
        document.getElementById('onboardingView').style.display = 'none';
        document.getElementById('onboardingSyncInput').style.display = 'flex';
      };

      window.backToOnboarding = function() {
        document.getElementById('onboardingSyncInput').style.display = 'none';
        document.getElementById('onboardingView').style.display = 'flex';
      };

      window.linkOnboardingSyncCode = function() {
        const input = document.getElementById('onboardingSyncCodeInput');
        const code = input.value.trim().toLowerCase();

        if (!code) {
          alert('Please enter a sync code');
          return;
        }

        // Set sync code and trigger Firebase sync
        appState.syncCode = code;
        localStorage.setItem(STORAGE_KEYS.SYNC_CODE, code);

        // TODO: Load data from Firebase using sync code
        console.log('ðŸ”‘ Sync code set:', code);

        showApp();
      };

      function showApp() {
        document.getElementById('onboardingView').style.display = 'none';
        document.getElementById('onboardingSyncInput').style.display = 'none';
        document.getElementById('mainApp').classList.add('active');

        // Load all data
        if (currentUser) {
          loadIdeas();
          loadRecipes();
          loadHistory();
        }
      }

      function checkOnboardingState() {
        const savedSpace = localStorage.getItem(STORAGE_KEYS.SPACE);
        const savedSyncCode = localStorage.getItem(STORAGE_KEYS.SYNC_CODE);

        if (savedSpace) {
          appState.space = JSON.parse(savedSpace);
        }
        if (savedSyncCode) {
          appState.syncCode = savedSyncCode;
        }

        // If space exists, show app; otherwise show onboarding
        if (appState.space && currentUser) {
          showApp();
        } else if (!appState.space) {
          document.getElementById('onboardingView').style.display = 'flex';
        }
      }

      // ==================== AUTO TAG EXTRACTION ====================
      // Food-related keywords to look for
      const FOOD_KEYWORDS = {
        proteins: ['chicken', 'beef', 'pork', 'fish', 'salmon', 'tuna', 'shrimp', 'turkey', 'lamb', 'tofu'],
        carbs: ['pasta', 'rice', 'bread', 'noodles', 'potato', 'quinoa', 'couscous'],
        veggies: ['veggie', 'vegetable', 'broccoli', 'spinach', 'kale', 'carrot', 'tomato', 'pepper', 'mushroom', 'salad'],
        cuisines: ['italian', 'chinese', 'mexican', 'thai', 'indian', 'japanese', 'korean'],
        methods: ['grilled', 'baked', 'fried', 'roasted', 'steamed', 'boiled'],
        speed: ['quick', 'easy', 'fast', '30 minute', '15 minute'],
        occasions: ['guest-friendly', 'party', 'weeknight', 'meal prep']
      };

      async function extractTagsFromImage(file) {
        try {
          // Show loading indicator
          const tagsInput = document.getElementById('ideaTagsInput');
          const originalPlaceholder = tagsInput.placeholder;
          tagsInput.placeholder = 'Analyzing image...';
          tagsInput.disabled = true;

          // Perform OCR on the image
          const { data: { text } } = await Tesseract.recognize(file, 'eng', {
            logger: m => console.log(m)
          });

          // Extract tags from detected text
          const detectedTags = analyzeTextForTags(text);

          // Update tags input
          tagsInput.value = detectedTags.join(', ');
          tagsInput.placeholder = originalPlaceholder;
          tagsInput.disabled = false;

          console.log('âœ… Auto-detected tags:', detectedTags);
          return detectedTags;
        } catch (error) {
          console.error('Tag extraction error:', error);
          const tagsInput = document.getElementById('ideaTagsInput');
          tagsInput.placeholder = 'Tags (optional, comma-separated)';
          tagsInput.disabled = false;
          return [];
        }
      }

      function analyzeTextForTags(text) {
        const lowerText = text.toLowerCase();
        const foundTags = new Set();

        // Check all food keyword categories
        Object.values(FOOD_KEYWORDS).flat().forEach(keyword => {
          if (lowerText.includes(keyword)) {
            // Map to standard tags
            if (['chicken', 'beef', 'pork', 'fish', 'salmon', 'tuna', 'shrimp'].includes(keyword)) {
              if (keyword === 'salmon' || keyword === 'tuna' || keyword === 'shrimp') {
                foundTags.add('fish');
              } else {
                foundTags.add(keyword);
              }
            } else if (keyword === 'pasta' || lowerText.includes('noodle')) {
              foundTags.add('pasta');
            } else if (FOOD_KEYWORDS.veggies.includes(keyword) || keyword === 'salad') {
              foundTags.add('veggie');
            } else if (lowerText.includes('quick') || lowerText.includes('easy') || lowerText.includes('fast') || lowerText.includes('15') || lowerText.includes('30')) {
              foundTags.add('quick');
            } else if (lowerText.includes('guest') || lowerText.includes('party')) {
              foundTags.add('guest-friendly');
            }
          }
        });

        // Check for carb-heavy indicators
        if (lowerText.includes('pasta') || lowerText.includes('rice') || lowerText.includes('potato') || lowerText.includes('bread')) {
          foundTags.add('carb-heavy');
        }

        return Array.from(foundTags);
      }

      async function extractTagsFromRecipeImage(file) {
        try {
          // Show loading indicator
          const tagsInput = document.getElementById('recipeTags');
          const originalPlaceholder = tagsInput.placeholder;
          tagsInput.placeholder = 'Analyzing image...';
          tagsInput.disabled = true;

          // Perform OCR on the image
          const { data: { text } } = await Tesseract.recognize(file, 'eng', {
            logger: m => console.log(m)
          });

          // Extract tags from detected text
          const detectedTags = analyzeTextForTags(text);

          // Update tags input
          tagsInput.value = detectedTags.join(', ');
          tagsInput.placeholder = originalPlaceholder;
          tagsInput.disabled = false;

          console.log('âœ… Auto-detected recipe tags:', detectedTags);
          return detectedTags;
        } catch (error) {
          console.error('Recipe tag extraction error:', error);
          const tagsInput = document.getElementById('recipeTags');
          tagsInput.placeholder = 'Tags (optional, comma-separated)';
          tagsInput.disabled = false;
          return [];
        }
      }

      // ==================== APP LOGIC ====================
      let currentIdeaPhoto = null;
      let currentRecipeType = 'manual';
      let currentRecipePhoto = null;
      let allRecipes = [];

      // Idea photo upload
      document.getElementById('ideaPhotoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          currentIdeaPhoto = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('ideaPhotoPreview');
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
          
          // Auto-extract tags
          await extractTagsFromImage(file);
        }
      });

      window.removeIdeaPhoto = function() {
        currentIdeaPhoto = null;
        document.getElementById('ideaPhotoInput').value = '';
        document.getElementById('ideaPhotoPreview').style.display = 'none';
        document.getElementById('ideaPhotoPreview').querySelector('img').src = '';
      };

      // Add idea form
      document.getElementById('addIdeaForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;

        const note = document.getElementById('ideaNoteInput').value.trim();
        const link = document.getElementById('ideaLinkInput').value.trim();

        if (!note && !link && !currentIdeaPhoto) {
          alert('Please add a note, link, or photo');
          return;
        }

        try {
          let photoUrl = null;
          if (currentIdeaPhoto) {
            const storageRef = storage.ref();
            const photoRef = storageRef.child(`ideas/${currentUser.uid}/${Date.now()}_${currentIdeaPhoto.name}`);
            await photoRef.put(currentIdeaPhoto);
            photoUrl = await photoRef.getDownloadURL();
          }

          const tags = document.getElementById('ideaTagsInput').value
            .split(',')
            .map(t => t.trim().toLowerCase())
            .filter(t => t);

          await db.collection('ideas').add({
            note: note,
            link: link || null,
            photo_url: photoUrl,
            tags: tags,
            created_at: firebase.firestore.FieldValue.serverTimestamp(),
            user_id: currentUser.uid
          });

          document.getElementById('addIdeaForm').reset();
          document.getElementById('ideaPhotoPreview').style.display = 'none';
          currentIdeaPhoto = null;
        } catch (error) {
          console.error('Error saving idea:', error);
          alert('Error saving idea: ' + error.message);
        }
      });

      function loadIdeas() {
        if (!currentUser) return;
        db.collection('ideas')
          .where('user_id', '==', currentUser.uid)
          .orderBy('created_at', 'desc')
          .onSnapshot((snapshot) => {
            const ideasList = document.getElementById('ideasList');
            const emptyState = document.getElementById('ideasEmptyState');
            
            if (snapshot.empty) {
              ideasList.innerHTML = '';
              emptyState.style.display = 'block';
              return;
            }
            
            emptyState.style.display = 'none';
            ideasList.innerHTML = '';
            
            snapshot.forEach((doc) => {
              const idea = doc.data();
              const card = createIdeaCard(doc.id, idea);
              ideasList.appendChild(card);
            });
          });
      }

      function createIdeaCard(id, idea) {
        const card = document.createElement('div');
        card.className = 'idea-card';
        
        let contentHTML = '';
        if (idea.note) contentHTML += `<div class="idea-card-value">${idea.note}</div>`;
        
        if (idea.link) {
          contentHTML += `<a href="${idea.link}" target="_blank" class="idea-card-link" style="display: block; margin-top: 8px; color: #475569; text-decoration: underline;">${idea.link}</a>`;
        }
        
        if (idea.photo_url) {
          contentHTML += `<img src="${idea.photo_url}" class="idea-card-photo" style="max-width: 500px; max-height: 500px; width: 100%; border-radius: 8px; margin-top: 8px; object-fit: contain;">`;
        }
        
        const tagsHTML = idea.tags?.length > 0
          ? idea.tags.map(t => `<span class="tag">${t}</span>`).join('')
          : '';
          
        card.innerHTML = `
          ${contentHTML}
          ${tagsHTML ? `<div style="margin-top: 8px;">${tagsHTML}</div>` : ''}
          <div class="idea-card-actions" style="margin-top: 12px; display: flex; gap: 8px;">
            <button class="btn-small btn-delete" onclick="deleteIdea('${id}')">Delete</button>
          </div>
        `;
        return card;
      }

      // Confirm modal functions
      function showConfirm(title, subtitle, onConfirm, confirmText = 'Confirm') {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmSubtitle').textContent = subtitle;

        const btn = document.getElementById('confirmBtn');
        btn.textContent = confirmText;
        btn.onclick = () => {
          onConfirm();
          closeConfirmModal();
        };

        // Show cancel button
        const modal = document.getElementById('confirmModal');
        const cancelBtn = modal.querySelector('.modal-btn-secondary');
        if (cancelBtn) cancelBtn.style.display = '';

        modal.classList.add('active');
      }

      function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
      }

      window.deleteIdea = async (id) => {
        showConfirm(
          'Delete this idea?',
          'This action cannot be undone.',
          async () => {
            await db.collection('ideas').doc(id).delete();
          },
          'Delete'
        );
      };

      window.deleteRecipe = async (id) => {
        showConfirm(
          'Delete this recipe?',
          'This action cannot be undone.',
          async () => {
            await db.collection('recipes').doc(id).delete();
          },
          'Delete'
        );
      };

      // Recipe detail modal functions
      async function openRecipeDetail(recipeId) {
        const doc = await db.collection('recipes').doc(recipeId).get();
        if (!doc.exists) return;

        const recipe = doc.data();
        const content = document.getElementById('recipeDetailContent');

        const photoHTML = recipe.photos?.length > 0
          ? `<img src="${recipe.photos[0]}" style="width: 100%; border-radius: 8px; margin-bottom: 16px; max-height: 300px; object-fit: cover;">`
          : '';

        const ingredientsHTML = recipe.ingredients?.length > 0
          ? `<div style="margin-bottom: 16px;">
               <h4 style="font-size: 14px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Ingredients</h4>
               <ul style="list-style: none; padding: 0; margin: 0;">
                 ${recipe.ingredients.map(ing => `<li style="padding: 6px 0; border-bottom: 1px solid #F1F5F9; font-size: 14px; color: #333;">${ing.name}</li>`).join('')}
               </ul>
             </div>`
          : '';

        const notesHTML = recipe.notes
          ? `<div style="margin-bottom: 16px;">
               <h4 style="font-size: 14px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Notes</h4>
               <p style="font-size: 14px; color: #333; line-height: 1.6; white-space: pre-wrap;">${recipe.notes}</p>
             </div>`
          : '';

        const linkHTML = recipe.source_type === 'link' && recipe.source_value
          ? `<div style="margin-bottom: 16px;">
               <h4 style="font-size: 14px; font-weight: 600; color: #64748B; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Source</h4>
               <a href="${recipe.source_value}" target="_blank" style="color: #BF3143; text-decoration: none; font-size: 14px;">${recipe.source_value}</a>
             </div>`
          : '';

        const tagsHTML = recipe.tags?.length > 0
          ? `<div style="margin-top: 16px;">
               ${recipe.tags.map(t => `<span class="tag">${t}</span>`).join('')}
             </div>`
          : '';

        content.innerHTML = `
          ${photoHTML}
          <h2 style="font-size: 22px; font-weight: 600; color: #333; margin-bottom: 16px;">${recipe.name}</h2>
          ${linkHTML}
          ${ingredientsHTML}
          ${notesHTML}
          ${tagsHTML}
          <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid #F1F5F9;">
            <button class="btn-secondary" onclick="editRecipe('${recipeId}')" style="width: 100%;">Edit Recipe</button>
          </div>
        `;

        document.getElementById('recipeDetailModal').classList.add('active');
      }

      function closeRecipeDetail() {
        document.getElementById('recipeDetailModal').classList.remove('active');
      }

      let currentEditRecipePhoto = null;
      let currentEditRecipePhotoUrl = null;
      let shouldDeletePhoto = false;

      async function editRecipe(recipeId) {
        // Close detail modal
        closeRecipeDetail();

        // Reset photo state
        currentEditRecipePhoto = null;
        currentEditRecipePhotoUrl = null;
        shouldDeletePhoto = false;

        // Fetch recipe data
        const doc = await db.collection('recipes').doc(recipeId).get();
        if (!doc.exists) return;

        const recipe = doc.data();

        // Populate edit modal with existing data
        document.getElementById('editRecipeName').value = recipe.name || '';
        document.getElementById('editRecipeIngredients').value = recipe.ingredients?.map(i => i.name).join('\n') || '';
        document.getElementById('editRecipeNotes').value = recipe.notes || '';
        document.getElementById('editRecipeTags').value = recipe.tags?.join(', ') || '';
        document.getElementById('editRecipeId').value = recipeId;

        // Show existing photo if available
        const preview = document.getElementById('editRecipePhotoPreview');
        if (recipe.photos && recipe.photos.length > 0) {
          currentEditRecipePhotoUrl = recipe.photos[0];
          preview.querySelector('img').src = currentEditRecipePhotoUrl;
          preview.style.display = 'block';
          document.getElementById('editRecipePhotoButtonText').textContent = 'Change Photo';
        } else {
          preview.style.display = 'none';
          document.getElementById('editRecipePhotoButtonText').textContent = 'Choose Photo';
        }

        // Show edit modal
        document.getElementById('editRecipeModal').classList.add('active');
      }

      function removeEditRecipePhoto() {
        shouldDeletePhoto = true;
        currentEditRecipePhoto = null;
        currentEditRecipePhotoUrl = null;
        document.getElementById('editRecipePhotoPreview').style.display = 'none';
        document.getElementById('editRecipePhotoButtonText').textContent = 'Choose Photo';
      }

      async function findImageOnline() {
        const recipeName = document.getElementById('editRecipeName').value.trim();
        if (!recipeName) {
          alert('Please enter a recipe name first');
          return;
        }

        const imageUrl = await fetchRecipeImage(recipeName);
        if (imageUrl) {
          // Add cache busting to get a new random image each time
          const urlWithCacheBust = imageUrl.includes('?')
            ? `${imageUrl}&t=${Date.now()}`
            : `${imageUrl}?t=${Date.now()}`;

          currentEditRecipePhotoUrl = imageUrl;
          currentEditRecipePhoto = null;
          shouldDeletePhoto = false;
          const preview = document.getElementById('editRecipePhotoPreview');
          preview.querySelector('img').src = urlWithCacheBust;
          preview.style.display = 'block';
          document.getElementById('editRecipePhotoButtonText').textContent = 'Change Photo';
        } else {
          alert('Could not find an image online. Please try uploading your own.');
        }
      }

      // Handle photo selection for edit
      document.getElementById('editRecipePhotoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          currentEditRecipePhoto = file;
          shouldDeletePhoto = false;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('editRecipePhotoPreview');
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
            document.getElementById('editRecipePhotoButtonText').textContent = 'Change Photo';
          };
          reader.readAsDataURL(file);
        }
      });

      async function saveRecipeEdit() {
        const recipeId = document.getElementById('editRecipeId').value;
        const name = document.getElementById('editRecipeName').value.trim();
        const ingredientsText = document.getElementById('editRecipeIngredients').value;
        const notes = document.getElementById('editRecipeNotes').value.trim();
        const tags = document.getElementById('editRecipeTags').value
          .split(',')
          .map(t => t.trim().toLowerCase())
          .filter(t => t);

        if (!name) {
          alert('Please enter a recipe name');
          return;
        }

        const ingredients = ingredientsText.split('\n').map(line => line.trim()).filter(l => l).map(l => ({ name: l }));

        // Handle photo changes
        let photos = [];
        if (currentEditRecipePhoto) {
          // Upload new photo
          const storageRef = storage.ref();
          const photoRef = storageRef.child(`recipes/${currentUser.uid}/${Date.now()}_${currentEditRecipePhoto.name}`);
          await photoRef.put(currentEditRecipePhoto);
          const photoUrl = await photoRef.getDownloadURL();
          photos = [photoUrl];
        } else if (!shouldDeletePhoto && currentEditRecipePhotoUrl) {
          // Keep existing photo (could be from upload or online search)
          photos = [currentEditRecipePhotoUrl];
        }
        // If shouldDeletePhoto is true and no new photo, photos stays empty

        await db.collection('recipes').doc(recipeId).update({
          name,
          ingredients,
          notes,
          tags,
          photos
        });

        document.getElementById('editRecipeModal').classList.remove('active');
      }

      function closeEditRecipe() {
        document.getElementById('editRecipeModal').classList.remove('active');
      }

      window.openRecipeDetail = openRecipeDetail;
      window.editRecipe = editRecipe;
      window.removeEditRecipePhoto = removeEditRecipePhoto;
      window.findImageOnline = findImageOnline;

      // Auto-fetch recipe image from free food API
      async function fetchRecipeImage(recipeName) {
        try {
          // Try to get a specific dish from Foodish API if available
          const dishMap = {
            'pizza': 'pizza',
            'burger': 'burger',
            'pasta': 'pasta',
            'rice': 'rice',
            'dessert': 'dessert',
            'cake': 'dessert',
            'dosa': 'dosa',
            'biryani': 'biryani',
            'samosa': 'samosa',
            'idly': 'idly'
          };

          const lowerName = recipeName.toLowerCase();
          let dish = null;

          // Check if recipe name contains any known dish
          for (const [key, value] of Object.entries(dishMap)) {
            if (lowerName.includes(key)) {
              dish = value;
              break;
            }
          }

          let apiUrl = 'https://foodish-api.com/api/';
          if (dish) {
            apiUrl = `https://foodish-api.com/api/images/${dish}`;
          }

          const response = await fetch(apiUrl);
          if (response.ok) {
            const data = await response.json();
            return data.image;
          }

          return null;
        } catch (error) {
          console.error('Error fetching recipe image:', error);
          return null;
        }
      }

      // Settings functions
      function generateSyncCode() {
        return Math.random().toString(36).substring(2, 8).toUpperCase();
      }

      function ensureSyncCode() {
        let code = localStorage.getItem('tinyMeals_syncCode');
        if (!code) {
          code = generateSyncCode();
          localStorage.setItem('tinyMeals_syncCode', code);
          console.log('âœ… Generated sync code:', code);
        }
        return code;
      }

      function showSyncCodeCard() {
        const syncCodeCard = document.getElementById('syncCodeCard');
        const code = ensureSyncCode();

        document.getElementById('syncCodeDisplay').textContent = code;
        syncCodeCard.style.display = 'flex';
      }

      async function shareSyncCode() {
        const code = ensureSyncCode();

        if (navigator.share) {
          try {
            await navigator.share({
              title: 'Tiny Meals Sync Code',
              text: `Join my Tiny Meals space! Use this sync code: ${code}`
            });
          } catch (err) {
            if (err.name !== 'AbortError') {
              copySyncCode();
            }
          }
        } else {
          copySyncCode();
        }
      }

      function copySyncCode() {
        const code = ensureSyncCode();

        navigator.clipboard.writeText(code).then(() => {
          showAlert('Sync code copied to clipboard!');
        });
      }

      async function submitSyncCode() {
        const input = document.getElementById('enterSyncCodeInput');
        const code = input.value.trim();

        if (!code) {
          showAlert('Please enter a sync code');
          return;
        }

        try {
          const doc = await db.collection('tinyMeals').doc(code).get();
          if (!doc.exists) {
            showAlert('Invalid sync code. Please check and try again.');
            return;
          }

          localStorage.setItem('tinyMeals_syncCode', code);
          showAlert('Successfully connected to sync code!');
          input.value = '';
          location.reload();
        } catch (error) {
          console.error('Error linking sync code:', error);
          showAlert('Failed to link sync code. Please try again.');
        }
      }

      function exportData() {
        showConfirm(
          'Export Data?',
          'This will download all your recipes, ideas, and settings as a JSON file.',
          async () => {
            try {
              const userId = auth.currentUser?.uid;
              if (!userId) return;

              const [recipesSnap, ideasSnap] = await Promise.all([
                db.collection('recipes').where('user_id', '==', userId).get(),
                db.collection('ideas').where('user_id', '==', userId).get()
              ]);

              const data = {
                version: '1.0',
                exported: new Date().toISOString(),
                syncCode: localStorage.getItem('tinyMeals_syncCode'),
                recipes: recipesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                ideas: ideasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
              };

              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `tiny-meals-export-${new Date().toISOString().split('T')[0]}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              showAlert('Data exported successfully!');
            } catch (error) {
              console.error('Export error:', error);
              showAlert('Failed to export data. Please try again.');
            }
          },
          'Export'
        );
      }

      function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (!data.version || !data.recipes || !data.ideas) {
              showAlert('Invalid backup file format.');
              return;
            }

            showConfirm(
              'Import Data?',
              `This will import ${data.recipes.length} recipes and ${data.ideas.length} ideas. Existing data will not be deleted.`,
              async () => {
                try {
                  const userId = auth.currentUser?.uid;
                  if (!userId) return;

                  for (const recipe of data.recipes) {
                    const { id, ...recipeData } = recipe;
                    recipeData.user_id = userId;
                    await db.collection('recipes').add(recipeData);
                  }

                  for (const idea of data.ideas) {
                    const { id, ...ideaData } = idea;
                    ideaData.user_id = userId;
                    await db.collection('ideas').add(ideaData);
                  }

                  showAlert('Data imported successfully!');
                  location.reload();
                } catch (error) {
                  console.error('Import error:', error);
                  showAlert('Failed to import data. Please try again.');
                }
              },
              'Import'
            );
          } catch (error) {
            console.error('File read error:', error);
            showAlert('Failed to read backup file.');
          }
        };
        input.click();
      }

      function disconnectSync() {
        showConfirm(
          'Disconnect Sync?',
          'This will disconnect this device from sync. Your data will remain on this device.',
          () => {
            localStorage.removeItem('tinyMeals_syncCode');
            showAlert('Sync disconnected successfully.');
          },
          'Disconnect'
        );
      }

      function resetApp() {
        showConfirm(
          'Reset Everything?',
          'This will delete all data from this device and disconnect from sync. This cannot be undone.',
          async () => {
            try {
              const userId = auth.currentUser?.uid;
              if (userId) {
                const [recipesSnap, ideasSnap] = await Promise.all([
                  db.collection('recipes').where('user_id', '==', userId).get(),
                  db.collection('ideas').where('user_id', '==', userId).get()
                ]);

                const batch = db.batch();
                recipesSnap.docs.forEach(doc => batch.delete(doc.ref));
                ideasSnap.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
              }

              localStorage.clear();
              location.reload();
            } catch (error) {
              console.error('Reset error:', error);
              showAlert('Failed to reset. Please try again.');
            }
          },
          'Reset'
        );
      }

      function showAlert(message) {
        alert(message);
      }

      window.showSyncCodeCard = showSyncCodeCard;
      window.shareSyncCode = shareSyncCode;
      window.copySyncCode = copySyncCode;
      window.submitSyncCode = submitSyncCode;
      window.exportData = exportData;
      window.importData = importData;
      window.disconnectSync = disconnectSync;
      window.resetApp = resetApp;

      // Recipe Logic
      const recipeModalTabs = document.querySelectorAll('#addRecipeModal .idea-tab');
      const recipeModalSections = document.querySelectorAll('#addRecipeModal .idea-input-section');

      recipeModalTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const type = tab.getAttribute('data-type');
          switchRecipeTab(type);
        });
      });

      function switchRecipeTab(type) {
        currentRecipeType = type;
        recipeModalTabs.forEach(t => t.classList.remove('active'));
        document.querySelector(`#addRecipeModal .idea-tab[data-type="${type}"]`).classList.add('active');
        recipeModalSections.forEach(s => s.classList.remove('active'));
        document.querySelector(`#addRecipeModal .idea-input-section[data-section="${type}"]`).classList.add('active');
      }

      document.getElementById('recipePhotoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          currentRecipePhoto = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('recipePhotoPreview');
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
          await extractTagsFromRecipeImage(file);
        }
      });

      document.getElementById('recipePhotoManual').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          currentRecipePhoto = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('recipePhotoPreviewManual');
            preview.querySelector('img').src = e.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }
      });

      document.getElementById('addRecipeBtn').addEventListener('click', () => {
        document.getElementById('addRecipeModal').classList.add('active');
      });

      document.getElementById('closeRecipeModal').addEventListener('click', () => {
        document.getElementById('addRecipeModal').classList.remove('active');
      });

      document.getElementById('addRecipeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;

        let name = '';
        let sourceType = currentRecipeType;
        let sourceValue = '';
        let ingredients = [];
        let notes = '';
        let photos = [];

        if (currentRecipeType === 'manual') {
          name = document.getElementById('recipeNameManual').value.trim();
          sourceValue = document.getElementById('recipeUrlManual').value.trim();
          const ingredientsText = document.getElementById('recipeIngredients').value;
          ingredients = parseIngredients(ingredientsText);
          notes = document.getElementById('recipeNotes').value.trim();

          // Upload photo if provided
          if (currentRecipePhoto) {
            const storageRef = storage.ref();
            const photoRef = storageRef.child(`recipes/${currentUser.uid}/${Date.now()}_${currentRecipePhoto.name}`);
            await photoRef.put(currentRecipePhoto);
            const photoUrl = await photoRef.getDownloadURL();
            photos = [photoUrl];
          }

          if (sourceValue) {
            sourceType = 'link';
          }
        } else if (currentRecipeType === 'link') {
          name = document.getElementById('recipeNameLink').value.trim();
          sourceValue = document.getElementById('recipeUrl').value.trim();
          const ingredientsText = document.getElementById('recipeIngredientsLink').value;
          ingredients = parseIngredients(ingredientsText);
          notes = document.getElementById('recipeNotesLink').value.trim();
        } else if (currentRecipeType === 'photo') {
          name = document.getElementById('recipeNamePhoto').value.trim();
          if (currentRecipePhoto) {
            const storageRef = storage.ref();
            const photoRef = storageRef.child(`recipes/${currentUser.uid}/${Date.now()}_${currentRecipePhoto.name}`);
            await photoRef.put(currentRecipePhoto);
            const photoUrl = await photoRef.getDownloadURL();
            photos = [photoUrl];
            sourceValue = photoUrl;
          }
          notes = document.getElementById('recipeNotesPhoto').value.trim();
        }

        if (!name) {
          alert('Please enter a recipe name');
          return;
        }

        const tags = document.getElementById('recipeTags').value
          .split(',')
          .map(t => t.trim().toLowerCase())
          .filter(t => t);

        try {
          await db.collection('recipes').add({
            name,
            source_type: sourceType,
            source_value: sourceValue,
            ingredients,
            tags,
            notes,
            photos,
            user_id: currentUser.uid,
            created_at: firebase.firestore.FieldValue.serverTimestamp()
          });

          document.getElementById('addRecipeModal').classList.remove('active');
          document.getElementById('addRecipeForm').reset();
          document.getElementById('recipePhotoPreview').style.display = 'none';
          document.getElementById('recipePhotoPreviewManual').style.display = 'none';
          currentRecipePhoto = null;
        } catch (error) {
          console.error('Error adding recipe:', error);
          alert('Error adding recipe: ' + error.message);
        }
      });

      function parseIngredients(text) {
        if (!text) return [];
        return text.split('\n').map(line => line.trim()).filter(l => l).map(l => ({ name: l }));
      }

      function loadRecipes() {
        if (!currentUser) return;
        db.collection('recipes')
          .where('user_id', '==', currentUser.uid)
          .orderBy('created_at', 'desc')
          .onSnapshot((snapshot) => {
            const list = document.getElementById('recipesList');
            const empty = document.getElementById('recipesEmptyState');

            if (snapshot.empty) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            list.innerHTML = '';

            snapshot.forEach(doc => {
                const recipe = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'card';
                card.style.position = 'relative';
                card.style.cursor = 'pointer';
                card.onclick = (e) => {
                    // Don't open if clicking delete button
                    if (e.target.closest('button')) return;
                    openRecipeDetail(doc.id);
                };
                const tagsHTML = recipe.tags?.map(t => `<span class="tag">${t}</span>`).join('') || '';
                const photoHTML = recipe.photos?.length > 0
                    ? `<div style="width: 80px; height: 80px; flex-shrink: 0; margin-left: 16px;">
                         <img src="${recipe.photos[0]}" style="width: 100%; height: 100%; border-radius: 8px; object-fit: cover;">
                       </div>`
                    : '';
                card.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${recipe.name}</div>
                            <div style="font-size: 13px; color: #64748B; margin-bottom: 8px;">${recipe.ingredients?.length || 0} ingredients</div>
                            <div>${tagsHTML}</div>
                        </div>
                        ${photoHTML}
                    </div>
                    <button onclick="deleteRecipe('${doc.id}')" style="position: absolute; top: 12px; right: 12px; background: transparent; border: none; cursor: pointer; padding: 4px; color: #94A3B8; opacity: 0.6; transition: all 0.2s; display: flex; align-items: center; justify-content: center; z-index: 10;" onmouseover="this.style.color='#BF3143'; this.style.opacity='1'" onmouseout="this.style.color='#94A3B8'; this.style.opacity='0.6'">
                        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2;">
                            <line x1="18" y1="6" x2="6" y2="18" stroke-linecap="round"/>
                            <line x1="6" y1="6" x2="18" y2="18" stroke-linecap="round"/>
                        </svg>
                    </button>
                `;
                list.appendChild(card);
            });
          }, (error) => {
            console.error('Error loading recipes:', error);
            if (error.code === 'failed-precondition' || error.code === 'unimplemented') {
              console.error('Firestore index required. Please check the Firebase console for the index creation link.');
            }
          });

        // Load all recipes for planning
        db.collection('recipes')
            .where('user_id', '==', currentUser.uid)
            .onSnapshot((snapshot) => {
              allRecipes = [];
              snapshot.forEach((doc) => {
                allRecipes.push({ id: doc.id, ...doc.data() });
              });
              initializeWeeklyPlanning();
            });
      }

      // Placeholder functions
      function loadHistory() {}
      function loadGroceryList() {}

      // Weekly Planning
      let aprilPicks = [];
      let nathanPicks = [];
      let currentSelectingUser = null;
      let currentSelectingSlot = null;

      function initializeWeeklyPlanning() {
        // Update week date to show upcoming Sunday
        updateWeekDate();

        if (!allRecipes || allRecipes.length === 0) {
          // Show empty state or initialize with empty slots
          renderPlanningSlots();
          return;
        }
        renderPlanningSlots();
      }

      function updateWeekDate() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.

        // Calculate days until next Sunday (or today if it's Sunday)
        const daysUntilSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;

        const upcomingSunday = new Date(today);
        upcomingSunday.setDate(today.getDate() + daysUntilSunday);

        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames[upcomingSunday.getMonth()];
        const day = upcomingSunday.getDate();
        const year = upcomingSunday.getFullYear();

        document.getElementById('weekDate').textContent = `Week of ${month} ${day}, ${year}`;
      }

      function renderPlanningSlots() {
        const aprilContainer = document.getElementById('aprilSlots');
        const nathanContainer = document.getElementById('nathanSlots');

        aprilContainer.innerHTML = '';
        nathanContainer.innerHTML = '';

        // Create 5 slots for each person
        for (let i = 0; i < 5; i++) {
          // April's slot
          const aprilSlot = createSlot(i, 'april', aprilPicks[i]);
          aprilContainer.appendChild(aprilSlot);

          // Nathan's slot
          const nathanSlot = createSlot(i, 'nathan', nathanPicks[i]);
          nathanContainer.appendChild(nathanSlot);
        }

        updateCounts();
      }

      function createSlot(index, user, recipe) {
        const slot = document.createElement('div');
        slot.className = 'selection-slot';
        slot.style.cssText = 'padding: 16px; background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; margin-bottom: 12px; cursor: pointer; min-height: 80px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;';

        slot.onmouseover = () => {
          if (!recipe) {
            slot.style.borderColor = '#BF3143';
            slot.style.background = '#fef2f2';
          }
        };

        slot.onmouseout = () => {
          if (!recipe) {
            slot.style.borderColor = '#cbd5e1';
            slot.style.background = '#f8fafc';
          }
        };

        if (recipe) {
          slot.style.border = '2px solid #e2e8f0';
          slot.style.background = '#ffffff';
          slot.style.justifyContent = 'space-between';

          const photoHTML = recipe.photos?.length > 0
            ? `<div style="width: 60px; height: 60px; flex-shrink: 0; margin-right: 12px;">
                 <img src="${recipe.photos[0]}" style="width: 100%; height: 100%; border-radius: 8px; object-fit: cover;">
               </div>`
            : '';

          slot.innerHTML = `
            ${photoHTML}
            <div style="flex: 1;">
              <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${recipe.name}</div>
              <div style="font-size: 13px; color: #64748B;">${recipe.ingredients?.length || 0} ingredients</div>
            </div>
            <button onclick="event.stopPropagation(); removeRecipeFromSlot('${user}', ${index})" style="padding: 8px; background: transparent; border: none; cursor: pointer; color: #94A3B8; transition: color 0.2s;" onmouseover="this.style.color='#BF3143'" onmouseout="this.style.color='#94A3B8'">
              <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; stroke: currentColor; fill: none; stroke-width: 2;">
                <line x1="18" y1="6" x2="6" y2="18" stroke-linecap="round"/>
                <line x1="6" y1="6" x2="18" y2="18" stroke-linecap="round"/>
              </svg>
            </button>
          `;
        } else {
          slot.innerHTML = `
            <div style="text-align: center; color: #94A3B8;">
              <svg viewBox="0 0 24 24" style="width: 32px; height: 32px; stroke: currentColor; fill: none; stroke-width: 2; margin-bottom: 8px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <div style="font-size: 14px;">Add recipe</div>
            </div>
          `;
        }

        slot.onclick = () => {
          if (!recipe) {
            openRecipePicker(user, index);
          }
        };

        return slot;
      }

      function openRecipePicker(user, slotIndex) {
        currentSelectingUser = user;
        currentSelectingSlot = slotIndex;

        const modal = document.getElementById('selectRecipeModal');
        const list = document.getElementById('selectRecipesList');
        const filtersContainer = document.getElementById('selectRecipeFilters');

        list.innerHTML = '';

        if (!allRecipes || allRecipes.length === 0) {
          list.innerHTML = '<div style="text-align: center; padding: 40px; color: #94A3B8;">No recipes yet. Add some recipes first!</div>';
          filtersContainer.innerHTML = '<span class="tag clickable active" data-filter="all">All</span>';
        } else {
          // Collect all unique tags from recipes
          const allTags = new Set();
          allRecipes.forEach(recipe => {
            if (recipe.tags && recipe.tags.length > 0) {
              recipe.tags.forEach(tag => allTags.add(tag));
            }
          });

          // Build filter bar with dynamic tags
          filtersContainer.innerHTML = '<span class="tag clickable active" data-filter="all">All</span>';
          Array.from(allTags).sort().forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'tag clickable';
            tagSpan.setAttribute('data-filter', tag);
            tagSpan.textContent = tag;
            filtersContainer.appendChild(tagSpan);
          });

          allRecipes.forEach(recipe => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.cssText = 'cursor: pointer; margin-bottom: 12px; transition: all 0.2s;';
            card.onmouseover = () => card.style.borderColor = '#BF3143';
            card.onmouseout = () => card.style.borderColor = '#E5E7EB';

            const photoHTML = recipe.photos?.length > 0
              ? `<div style="width: 60px; height: 60px; flex-shrink: 0; margin-right: 12px;">
                   <img src="${recipe.photos[0]}" style="width: 100%; height: 100%; border-radius: 8px; object-fit: cover;">
                 </div>`
              : '';

            const tagsHTML = recipe.tags?.map(t => `<span class="tag" style="font-size: 11px;">${t}</span>`).join('') || '';

            card.innerHTML = `
              <div style="display: flex; align-items: center;">
                ${photoHTML}
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 4px;">${recipe.name}</div>
                  <div style="font-size: 13px; color: #64748B; margin-bottom: 6px;">${recipe.ingredients?.length || 0} ingredients</div>
                  <div>${tagsHTML}</div>
                </div>
              </div>
            `;

            card.onclick = () => selectRecipeForSlot(recipe);
            list.appendChild(card);
          });
        }

        modal.classList.add('active');
      }

      function selectRecipeForSlot(recipe) {
        if (currentSelectingUser === 'april') {
          aprilPicks[currentSelectingSlot] = recipe;
        } else {
          nathanPicks[currentSelectingSlot] = recipe;
        }

        renderPlanningSlots();
        document.getElementById('selectRecipeModal').classList.remove('active');

        currentSelectingUser = null;
        currentSelectingSlot = null;
      }

      function removeRecipeFromSlot(user, index) {
        if (user === 'april') {
          aprilPicks[index] = null;
        } else {
          nathanPicks[index] = null;
        }
        renderPlanningSlots();
      }

      function updateCounts() {
        const aprilCount = aprilPicks.filter(r => r).length;
        const nathanCount = nathanPicks.filter(r => r).length;

        document.getElementById('aprilCount').textContent = `${aprilCount}/5`;
        document.getElementById('nathanCount').textContent = `${nathanCount}/5`;

        // Show continue button if both have at least 1 selection
        const continueBtn = document.getElementById('checkBalanceBtn');
        if (aprilCount > 0 && nathanCount > 0) {
          continueBtn.style.display = 'block';
        } else {
          continueBtn.style.display = 'none';
        }
      }

      // Close select recipe modal
      document.getElementById('closeSelectModal').addEventListener('click', () => {
        document.getElementById('selectRecipeModal').classList.remove('active');
      });

      // Auth state observer
      // Auto sign-in anonymously (like Tiny Nudge)
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          console.log('âœ… User signed in:', user.uid);
          checkOnboardingState();
        } else {
          // Sign in anonymously if not logged in
          auth.signInAnonymously()
            .then(() => console.log('âœ… Signed in anonymously'))
            .catch((err) => console.error('âŒ Auth failed:', err));
        }
      });

      // ==================== NAVIGATION ====================
      const navTabs = document.querySelectorAll('.nav-tab');
      const views = document.querySelectorAll('.view');

      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetView = tab.getAttribute('data-view');

          // Update nav tabs
          navTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          // Update views
          views.forEach(v => v.classList.remove('active'));
          document.getElementById(targetView).classList.add('active');

          // Load grocery list when navigating to grocery view
          if (targetView === 'groceryView') {
            loadGroceryList();
          }
        });
      });


      // ==================== INITIALIZE ON AUTH ====================
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          onboardingView.style.display = 'none';
          mainApp.classList.add('active');

          // Load data
          loadIdeas();
          loadRecipes();
          loadHistory();

          // Load all recipes for planning
          db.collection('recipes')
            .where('user_id', '==', user.uid)
            .onSnapshot((snapshot) => {
              allRecipes = [];
              snapshot.forEach((doc) => {
                allRecipes.push({ id: doc.id, ...doc.data() });
              });
              initializeWeeklyPlanning();
            });

          console.log('âœ… Logged in:', user.email);
        } else {
          currentUser = null;
          onboardingView.style.display = 'flex';
          mainApp.classList.remove('active');
        }
      });

      console.log('ðŸ½ï¸ Tiny Meals initialized');
    </script>
</body>
</html>
